# Amily2 精简指南（仅保留"自动总结"与"记忆表格"）

## 目标与范围
- 目标：将扩展精简到 **自动总结** + **记忆表格** 两条链路可用、其余功能关闭/移除，确保加载不报错。
- 适用版本：当前仓库（含 v1.4.5+ 配置），已在条目中标注关键行号便于对照。
- 成功标准：启动无缺失模块错误；事件流能自动总结、表格正常渲染/写回；无多余 API 调用。

## 关键依赖与易踩坑
- 入口导入：`index.js` 已裁剪为 Drawer + commands + events + table-system + tavern-helper，仅保留总结与表格链路；删除独立模块不会因导入失败崩溃。
- 事件流：`core/events.js:64-126` 在消息到达时调用正文优化与自动隐藏；精简时需删除/短路，否则缺文件或空开关也会执行。
- 总结链路：`core/historiographer.js:14` 依赖 `rag-processor.js` 录入世界书，`core/historiographer.js:16` 依赖 `PresetSettings` 获取提示词；删除这些模块前必须改用本地提示词或跳过录入。
- 自动隐藏：`core/historiographer.js:19,456` 与 `core/events.js:65,85` 默认调用 `autoHideManager`。如果删除文件，需在调用处加空值判断或关掉开关。
- UI 绑定：`ui/drawer.js:19,81-123` 仍加载翰林院（RAG）模板；`ui/bindings.js:706-755` 仍有返回主界面的按钮处理。删除 UI 文件前先移除绑定。
- 默认开关：表格启停读的是 `table_system_enabled`（`core/events.js:12-23,83-117`），不是指南里新增的键；总结自动触发读 `historiography*` 配置（`core/historiographer.js:45-85`）。

## 推荐精简流程（安全优先）
1) 备份：`git commit -am "pre-slim"` 或复制目录。
2) 先关停非保留功能（不改代码也能立即生效）  
   - 在 `utils/settings.js` 调低/关闭：`enabled: true` 保持；`plotOpt_enabled: false`；`optimizationEnabled: false`（如未存在则添加）；`historiographySmallAutoEnable: true/false` 按需；`table_system_enabled: true`；`filling_mode: 'main-api'`；保留 API Key、模型配置。  
   - UI 中同步关停：剧情推进、正文优化、RAG 面板全部关闭。
3) 精简入口与事件（避免缺模块崩溃）  
   - `index.js`：仅保留 Drawer、commands、events、table-system、historiographer、tavern-helper 相关逻辑；剧情优化/RAG 初始化已完全移除。  
   - `core/events.js`：删除正文优化分支；自动隐藏通过 `optional-modules` 可选加载，默认关闭。  
   - `core/commands.js`：只注册 `/summary` 系列与 `/table-*` 命令，所有正文优化/RAG 调整类命令已删除。  
4) 精简总结链路  
   - `core/historiographer.js:14,395,588,784`：去除 `ingestTextToHanlinyuan` 调用，或在函数内加空检查并直接 return；至少保证删除 RAG 后不会 throw。  
   - `core/historiographer.js:16,311,516`：若删除 `PresetSettings`，替换为内联提示词或简单 `messages.push({ role: 'user', content: formattedHistory })`。  
   - 若不再使用自动隐藏，移除 `executeAutoHide` 导入并删除调用。  
5) 精简 UI - **已实际完成**  
   - `ui/drawer.js`：移除翰林院加载与绑定；保留主殿、内阁（总结）、表格渲染。  
   - `ui/bindings.js`：删除与 RAG/优化/独立模块相关的按钮展示与跳转；仅保留总结、表格、抽屉基础逻辑。  
   - `ui/table-bindings.js`：简化表格事件绑定，移除复杂优化功能，保留核心表格操作。  
   - `ui/message-table-renderer.js`：保持精简版，只处理主API/记忆表格必需逻辑，无未定义函数。  
6) 清理默认样式/资产  
   - 保留 `assets/table*.css`、`assets/historiography*.css`，删除 RAG/优化相关 HTML/CSS/JS 后再删对应 `<link>` 引用。  
7) 删除文件（在完成上述代码改动后再执行）  
   - 可删除：`core/summarizer.js`、`core/rag-processor.js`、`core/rag-api.js`、`core/rag-settings.js`、`core/ingestion-manager.js`、`core/super-sorter.js`、`MiZheSi/`、`PresetSettings/`、`PreOptimizationViewer/`、`WorldEditor/`、`CharacterWorldBook/`、`glossary/`、`ui/hanlinyuan-bindings.js`。  
   - 如未重写调用方，暂时保留 `core/autoHideManager.js`，否则会在总结/事件里抛错。  
8) 验证  
   - 启动扩展，观察控制台无 `Failed to load module`。  
   - 触发 `/summary`、`checkAndTriggerAutoSummary` 自动总结，确认能写入世界书且不调用 RAG。  
   - 发送带表格命令消息，确认表格渲染/写回成功（`core/events.js:9-59` 路径）。  
   - 若保留自动隐藏，确认执行一次不报错；若移除，确认调用处已短路。

## 实际UI变更情况（阶段3完成状态）

### 5.1 UI文件精简状态
- **ui/bindings.js**：已精简 ✅  
  - 移除：优化功能、MiZheSi、PresetSettings、复杂世界书设置等独立模块引用  
  - 保留：核心授权、API配置、基础UI事件绑定、Drawer管理  
  - 事件：仅绑定基础配置输入、模型选择、操作按钮等核心功能  

- **ui/table-bindings.js**：已精简 ✅  
  - 移除：复杂NccsApi事件、模板编辑器复杂功能、独立规则编辑等  
  - 保留：核心表格操作、批量填表、模板编辑器简化版、聊天显示设置  
  - 绑定：批量填表、重新整理、填当前楼层等核心按钮  

- **ui/message-table-renderer.js**：已校准 ✅  
  - 状态：已经是精简版，符合主API/记忆表格必需逻辑要求  
  - 功能：表格渲染、持续渲染、聊天内表格显示，无未定义函数  

- **ui/drawer.js**：已在前期精简 ✅  
  - 状态：仅加载总结(historiography)和表格(Memorisation-forms)面板  
  - 绑定：bindModalEvents、bindHistoriographyEvents、bindTableEvents  

### 5.2 UI验证结果
- Drawer中仅显示总结与表格面板 ✅  
- 表格渲染正常，无未定义函数日志 ✅  
- 核心功能按钮全部可用，无缺依赖报错 ✅  

## 配置清单（精简后应保留/设置的键）
- `extensionName = "ST-Amily2-Chat-Optimisation"` 下：
  - 基础：`enabled: true`，`apiProvider/apiKey/model` 按需；`table_system_enabled: true`，`filling_mode: 'main-api'`。
  - 总结：`historiographySmallAutoEnable`、`historiographySmallTriggerThreshold`、`historiographyRetentionCount`、`lorebookTarget`。若缺少 PresetSettings，可直接沿用 `utils/settings.js` 中的默认提示词（详见"总结提示词"段）或在 UI 中覆盖 `historiographySmallJailbreakPrompt` / `historiographySmallSummaryPrompt` 及 `historiographyLargeJailbreakPrompt` / `historiographyLargeRefinePrompt`。
  - 表格：`tableSystemDefaultSettings` 维持默认，`injectMacro`、`batchSize` 按需。
- 关闭项：`optimizationEnabled: false`，`plotOpt_enabled: false`，RAG 相关布尔/端点均清空，`historiographyIngestToRag: false`（精简版无翰林院录入），`table_independent_rules_enabled: false`，`autoHideEnabled: false`（若未导入 `autoHideManager`）。
- **总结提示词**：精简版内置 fallback，不依赖 PresetSettings：
  - 微言录破限：`historiographySmallJailbreakPrompt` 默认以"你是酒馆国家的臣民……"为起手式；
  - 微言录总结：`historiographySmallSummaryPrompt` 默认输出 ≥10 条事件及权重；
  - 宏史卷破限与重铸：`historiographyLargeJailbreakPrompt` / `historiographyLargeRefinePrompt` 默认描述章节化的融合策略；
  - 如需自定义，可直接在 UI（敕史局面板）或设置文件中编辑，上述键缺省时会自动回退到默认值。

## 配置迁移策略
- **总结链路默认降级**：`core/historiographer.js` 内已加入可选导入，删除 `rag-processor.js` 或 `PresetSettings/` 时也不会崩溃；确保在 `utils/settings.js` 中将 `historiographyIngestToRag` 设为 `false`，必要时仅保留世界书写入。
- **表格链路默认降级**：`core/table-system/{batch-filler,secondary-filler,reorganizer}.js` 会在缺少 PresetSettings 时自动使用简化提示词与默认顺序；若仍需严格模板，可在 `docs/specs/251118-slim-core/dependency-map.md` 列出的键上补充自定义提示。
- **自动隐藏策略**：自动隐藏通过 `core/utils/optional-modules.js` 可选加载，默认 `autoHideEnabled: false`；删除 `core/autoHideManager.js` 不会抛错。
- **文档同步**：迁移完成后，请在 `docs/specs/251118-slim-core/tasks.md` 中记录完成的配置项，并在复盘模板里保存最终版本，以便未来继续裁剪。

## Slash 命令（精简版）
- `/summary [start] [end]`：按楼层范围生成微言录；省略参数时按默认批次。
- `/summary-expedition` / `/summary-stop`：批量远征总结与中止。
- `/table-refresh`：重新执行最新 AI 消息的主流程填表。
- `/table-secondary`：在分步模式下强制执行最新 AI 消息的副 API 填表。

## 验证用例
1. `/summary last10 micro`：应生成小总结写入世界书，无 RAG 请求。
2. 手动表格填充：发送含表格指令的 AI 回复，检查表格高亮和写回保存。
3. 自动触发：发送多轮对话达阈值后，后台自动总结执行且不报错。
4. 资源检查：浏览器控制台无 missing module / 404 / undefined 函数错误。
5. **UI检查**：Drawer面板仅显示总结和表格，无多余的翰林院/优化面板，表格渲染功能正常。

## FAQ
- **一定要删 RAG 文件吗？** 如果不想改总结代码，可保留 `core/rag-processor.js` 并在其中立刻 `return []`，用来兜底依赖；但推荐按步骤 4 改写调用方后再删除。  
- **自动隐藏想保留吗？** 可保留 `core/autoHideManager.js` 并继续调用；若删除，务必移除两处调用（`core/events.js:65,85` 与 `core/historiographer.js:456` 附近）。
- **UI精简后如何验证？** 参考"实际UI变更情况"章节的验证结果，确保所有核心功能正常工作且无缺依赖报错。